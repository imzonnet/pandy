function calculate() {
    if ($("input.empty").length > 0)return !1;
    var etp = getVal("#extraRepayment");
    var e, t = getVal("#pv"), a = getVal("#rate") / 100, n = getVal("#nper"), r = getVal("#pmtFreq"), l = getVal("#fee"), i = getVal("#feeFreq"), o = getVal("#feeTermination"), s = 0, p = getVal("#feeApplication"), c = getVal("#feeSwitching"), u = getVal("#newFee"), h = getVal("#newFeeFreq"), f = getVal("#newIntroRate") / 100, d = getVal("#newIntroNper"), v = getVal("#newRate") / 100, y = n - d, g = o + p + c, m = 0, b = 0, w = $("#pmtFreq option:selected").text().toLowerCase().replace("ly", "s"), F = !1, x = PMT(a / r, n * r, -t, m, b) + l * i / r + etp, M = x * n * r, T = t + g, V = PMT(f / r, n * r, -T, m, b) + u * h / r, C = FV(f / r, d * r, V - u * h / r, -T, b), k = PMT(v / r, y * r, -C, m, b) + u * h / r, N = V * d * r + k * (n - d) * r, I = 0;
    if (d > 0)for (_ = 1; d * r >= _; _++)if (_ * x - _ * V >= g) {
        I = _;
        break
    }
    if (0 === I)for (_ = 1; y * r >= _; _++)if (_ * x - _ * k >= g) {
        I = d * r + _;
        break
    }
    I = 0 >= M - N - g ? "negative" : g > 0 ? 0 === I ? "fee not recovered" : I + " " + w : "N/A";
    var A = PMT(f / r, n * r, -T, m, b) + u * h / r;
    x > A && (A = x);
    var R = FV(f / r, d * r, A, -T, b), q = PMT(v / r, n * r, -R, m, b) + u * h / r;
    x > q && (q = x);
    var P = NPER(v / r, q, -R, m, b);
    P += d * r;
    var S = parseInt(P.toFixed(6) / r), L = S + " years", D = Math.ceil(P.toFixed(6) / r % 1 * 12);
    D > 0 && (L = L + " " + D + " months"), 12 === D && (S += 1, D = 0);
    var E = A * d * r + q * (P - d * r), O = x;
    k > O && (O = k);
    var B = ('<p class="assumptions breaker"><strong>Assumptions:</strong></p><ul class="assumptions"><li>Total cost of current loan: ' + M.formatMoney(2) + " (" + x.formatMoney() + " per " + r.periodText() + ")</li><li>Total cost of new loan: " + N.formatMoney(2) + " (" + V.formatMoney() + " introductory and " + k.formatMoney() + " ongoing per " + r.periodText() + ")</li></ul>", []);
    B[0] = 0;
    var H = [];
    H[0] = 0;
    var W = [];
    if (W[0] = 0, F) {
        k = O, B[0] = t, H[0] = t + o + p + c;
        for (var _ = 1; n >= _; _++)B[_] = -FV(a / r, 1 * r, -x, B[_ - 1], b), H[_] = d >= _ ? -FV(f / r, 1 * r, -k, H[_ - 1], b) : -FV(v / r, 1 * r, -k, H[_ - 1], b), W[_] = B[_] - H[_]
    } else {
        B[0] = 0, H[0] = o + p + c;
        for (var _ = 1; n >= _; _++)B[_] = s >= _ ? introPmt : x, B[_] = B[_] * r, B[_] = B[_] + B[_ - 1], H[_] = d >= _ ? V : k, H[_] = H[_] * r, H[_] = H[_] + H[_ - 1], W[_] = B[_] - H[_]
    }
    e = "", M - N > 0 && I.replace(/[^0-9]/g, "").length > 0 && (e = "<li>your switching costs will be recovered in " + I + "</li>"), e = "<h4>Minimum repayments</h4><p>By switching loans and making the minimum repayment (" + k.formatMoney(0) + " per " + r.periodText() + "):</p><ul><li>will <span>" + (0 > M - N - g ? "cost " : "save ") + parseFloat(Math.abs(M - N - g)).formatMoney(0) + "</span> (" + (Math.abs(M - N - g) / (n * r)).formatMoney(0) + " per " + r.periodText() + ") over the life of the loan</li>" + e + "</ul>";
    var Y = parseFloat(n * r - P).toFixed(6);
    Y > 0 && M - N > 0 && (Y = parseInt(Y), e = e + '<h4 class="breaker">Higher repayments</h4><p>By switching loans and making higher repayments (' + x.formatMoney(0) + " per " + r.periodText() + ", the same minimum repayments as your current loan):</p><ul><li>will <span>" + (0 > M - N ? "cost " : "save ") + parseFloat(Math.abs(M - E)).formatMoney(0) + "</span> (" + (Math.abs(M - E) / P).formatMoney(0) + " per " + r.periodText() + ") over the life of the loan</li><li>you will pay off your loan " + Y + " " + r.periodText() + "s earlier</li></ul>"), $("#result").html(e), 0 > M - N - g && $("#result span").addClass("negative"), drawChart(W)
}
function PMT(e, t, a, n, r) {
    var l;
    if (0 === e)l = (a + n) / t; else {
        var i = Math.pow(1 + e, t);
        l = 1 === r ? (n * e / (i - 1) + a * e / (1 - 1 / i)) / (1 + e) : n * e / (i - 1) + a * e / (1 - 1 / i)
    }
    return -l
}
function FV(e, t, a, n, r) {
    var l;
    if (0 === e)l = n + a * t; else {
        var i = Math.pow(1 + e, t);
        l = 1 === r ? n * i + a * (1 + e) * (i - 1) / e : n * i + a * (i - 1) / e
    }
    return -l
}
function NPER(e, t, a, n, r) {
    void 0 === r && (r = 0);
    var l = t * (1 + e * r) - n * e, i = a * e + t * (1 + e * r);
    return 0 === e ? -(n + a) / t : Math.log(l / i) / Math.log(1 + e)
}
function DrawCalculator() {
    var e = "<h2>" + CALC_NAME + " calculator</h2>";
    $("#calculator-container").html(e), e = '<div class="break input"><h3>Current loan</h3><p><label for="pv">Loan balance: <span>($)</span></label><input type="text" id="pv" name="pv" class="dollars int empty"/></p><p><label for="rate">Interest rate: <span>(% p.a.)</span></label><input type="text" id="rate" class="interest float empty"/></p><p><label for="nper">Term remaining: <span>(years)</span></label><input type="text" id="nper" class="years int empty"/></p><p><label for="pmtFreq">Repayment frequency:</label><select id="pmtFreq"/></p><h4>Fees</h4><p><label for="fee">Regular fee: <span>($)</span></label><input type="text" id="fee" class="dollars int" value="$0"/></p><p><label for="feeFreq">Regular fee frequency:</label><select id="feeFreq"/></p><p><label for="feeTermination">Termination fee: <span>($)</span></label><input type="text" id="feeTermination" class="dollars int" value="$0"/></p><h3 class="breaker">New loan</h3><p><label for="newIntroRate">Introductory rate: <span>(% p.a.)</span></label><input type="text"  id="newIntroRate" class="interest float"/></p><p><label for="newIntroNper">Introductory period: <span>(years)</span></label><input type="text" id="newIntroNper" class="years int" value="0 years"/></p><p><label for="newRate">Ongoing rate: <span>(% p.a.)</span></label><input type="text" id="newRate" class="interest float empty"/></p><h4>Fees</h4><p><label for="feeApplication">Application fee: <span>($)</span></label><input type="text" id="feeApplication" class="dollars int" value="$0"/></p><p><label for="feeSwitching">Other switching fees: <span>($)</span></label><input type="text" id="feeSwitching" class="dollars int" value="$0"/></p><p><label for="newFee">Regular fee: <span>($)</span></label><input type="text"  id="newFee" class="dollars int" value="$0"/></p><p><label for="newFeeFreq">Regular fee frequency:</label><select id="newFeeFreq"/></p><p><label for="extraRepayment">Extra monthly repayment: <span>($)</span></label><input type="text" id="extraRepayment" class="dollars int" value="$100" /></p></div>', e += '<div class="break result"><h3>Results</h3><div class="result-box"><!--<h4 id="chart-intro"/>--><div id="chart"/><div id="result"/></div></div>', $("#calculator-container").append(e)
}
function drawChart(e) {
    for (var t = 0; t < e.length; t++) {
        var a = e[t], n = "#8b2d5c";
        e[t] = {y: a, color: n}
    }
    new Highcharts.Chart({
        chart: {renderTo: "chart", type: "column", marginBottom: 35, marginTop: 0},
        credits: {enabled: !1},
        legend: {enabled: !1},
        title: {text: null},
        xAxis: {min: 1, title: {text: "Years"}, allowDecimals: !1, minPadding: 0, maxPadding: 0},
        yAxis: {title: {text: "Cost/Saving"}, endOnTick: !1},
        plotOptions: {
            column: {stacking: "normal", dataLabels: {enabled: !1}},
            series: {borderWidth: 0, shadow: !1, groupPadding: .1, pointPadding: .05}
        },
        tooltip: {
            shared: !0, useHTML: !0, borderColor: "#6b8e06", formatter: function () {
                return s = "<strong>After " + this.x + " years</strong><br/>Switching will have ", s += this.points[0].y < 0 ? "cost you: " : "saved you: ", s += this.points[0].y.formatMoney(0), s
            }
        },
        series: [{name: "Cost/savings", data: e}]
    })
}
function getVal(e) {
    var t = $(e).val().toFloat();
    return t
}
var CALC_NAME = "Mortgage switching";
$(document).ready(function () {
    var e = (DrawCalculator(), '<option value="52">Weekly</option><option value="26">Fortnightly</option><option value="12" selected="selected">Monthly</option><option value="1">Annually</option>');
    $("#calculator-container .input select").html(e), $("#calculator-container .input .current input, #calculator-container .input .current select").each(function () {
        $(this).before("<label>Current loan - " + $(this).parent("p").prev("p").text() + "</label>")
    }), $("#calculator-container .input .new input, #calculator-container .input .new select").each(function () {
        $(this).before("<label>New loan - " + $(this).parent("p").prev("p").prev("p").text() + "</label>")
    }), $("#calculator-container input").attr("type", "tel"), $("input").on("keypress", function (e) {
        13 == e.keyCode && $(this).blur()
    }), $("#calculator-container input").focus(function () {
        this.select()
    }), $("#calculator-container input").mouseup(function (e) {
        e.preventDefault()
    }), $("#calculator-container input").blur(function () {
        if (this.value.length < 1 && $(this).val(0), $(this).hasClass("dollars") && $(this).val(this.value.toFloat().formatMoney(0)), $(this).hasClass("interest")) {
            var e = $(this).val().toFloat();
            e > 15 && (e = 15), $(this).val(e.toFixed(2) + "%")
        }
        $(this).hasClass("years") && $(this).val(parseInt(this.value) + " years"), "nper" == this.id && getVal("#nper") > 30 && $(this).val("30 years"), "newIntroNper" == this.id && getVal("#nper") <= getVal("#newIntroNper") && $(this).val(getVal("#nper") - 1 + " years"), calculate()
    }), $('#calculator-container select, #calculator-container input[type="checkbox"]').change(function () {
        calculate()
    }), $("input.int").keyup(function () {
        this.value = this.value.replace(/[^0-9]/g, "")
    }), $("input.float").keyup(function () {
        this.value = this.value.replace(/[^0-9\.]/g, "")
    }), $("#calculator-container input").focus(function () {
        this.select(), $(this).removeClass("empty")
    }), $("#result button").on("click", function () {
        $("#result table").slideToggle()
    })
}), String.prototype.toFloat = function () {
    var e = this;
    return e = e.replace(/[^0-9-.]/g, ""), (isNaN(e) || e.length < 1) && (e = 0), parseFloat(e)
}, Number.prototype.formatMoney = function (e, t, a, n) {
    e = isNaN(e = Math.abs(e)) ? 2 : e, t = void 0 === t ? "$" : t, n = void 0 === n ? "." : n, a = void 0 === a ? "," : a;
    var r = this, l = 0 > r ? "-" : "", i = parseInt(r = Math.abs(+r || 0).toFixed(e)) + "", o = (o = i.length) > 3 ? o % 3 : 0;
    return l + t + (o ? i.substr(0, o) + a : "") + i.substr(o).replace(/(\d{3})(?=\d)/g, "$1" + a) + (e ? n + Math.abs(r - i).toFixed(e).slice(2) : "")
}, Number.prototype.periodText = function () {
    return p = this, p = p.toString(), p = p.replace("52", "week"), p = p.replace("26", "fortnight"), p = p.replace("12", "month"), p = p.replace("1", "year"), p
};